{
  "id": "recent_staffing_analysis_panel",
  "version": "1.1.0",
  "title": "Recent Staffing Analysis Panel",
  "owner": "ops-analytics",
  "source_files": [
    "apps/ice-cream-ops/staffing-planner.js"
  ],
  "data_inputs": [
    {
      "name": "daily_actual_rows",
      "path": "sourceData.daily_actual[location]",
      "kind": "snapshot_json",
      "notes": "Scoped through recentActualRowsForScope() by lookback window and active store scope"
    },
    {
      "name": "planned_daily_targets",
      "path": "sourceData.planned_daily[location] or sourceData.daily_planned[location]",
      "kind": "snapshot_json",
      "notes": "Used in planned-vs-actual compare mode with baseline fallback"
    },
    {
      "name": "weather_context",
      "path": "weatherData[location][date]",
      "kind": "live_optional"
    },
    {
      "name": "saved_context_notes",
      "path": "state.recentAnalysisNotes",
      "kind": "ui_state_persisted"
    }
  ],
  "calculation_rules": [
    {
      "name": "lookback_window_scope",
      "formula_or_logic": "Anchor to latest eligible actual date across selected locations, then include lookbackWeeks * 7 days and sort by date/location",
      "references": [
        "apps/ice-cream-ops/staffing-planner.js:1820"
      ]
    },
    {
      "name": "expected_baseline_selection",
      "formula_or_logic": "Expected revenue/labor/profit uses planned daily values only when compare mode is planned_vs_actual and planned values are valid, otherwise falls back to historical weekday profile baseline",
      "references": [
        "apps/ice-cream-ops/staffing-planner.js:2823",
        "apps/ice-cream-ops/staffing-planner.js:2831"
      ]
    },
    {
      "name": "expected_source_attribution",
      "formula_or_logic": "Each location-day is classified as planned_targets, mixed_fallback, or historical_baseline_fallback; summary counts expose how often fallback logic was used",
      "references": [
        "apps/ice-cream-ops/staffing-planner.js:2837",
        "apps/ice-cream-ops/staffing-planner.js:2946"
      ]
    },
    {
      "name": "attainment_and_alignment_metrics",
      "formula_or_logic": "Derive profitability/sales/labor attainment percentages and weather-alignment summary rates for portfolio and location cards",
      "references": [
        "apps/ice-cream-ops/staffing-planner.js:2843",
        "apps/ice-cream-ops/staffing-planner.js:2910"
      ]
    }
  ],
  "visual_rules": [
    {
      "name": "meter_tones",
      "logic": "Attainment gauges use tone-strong/tone-close/tone-watch/tone-risk class thresholds from gaugeTone()",
      "token_refs": [
        "color.status.approved",
        "color.status.pending"
      ]
    },
    {
      "name": "weather_heat_tint",
      "logic": "Weather context cards apply weather-heat-hot/cold/neutral class from weather visual temp class"
    },
    {
      "name": "expected_source_disclosure",
      "logic": "Day cards and overview surface expected-source labels/details so fallback to historical baseline is explicit in planned-vs-actual mode"
    }
  ],
  "interactions": [
    {
      "action": "change_analysis_scope_window_compare_mode",
      "effect": "Recomputes rows, attainment metrics, and weather-alignment summaries"
    },
    {
      "action": "draft_and_save_context_note",
      "effect": "Persists note drafts and saved notes for location/date review context"
    }
  ],
  "states": [
    {
      "name": "default",
      "description": "Rows available and full summary/location/day cards rendered"
    },
    {
      "name": "no_recent_rows",
      "description": "No recent actual rows available for selected scope/window"
    },
    {
      "name": "weather_unavailable",
      "description": "Weather feed error shown; narrative falls back to non-weather variance commentary"
    },
    {
      "name": "planned_target_fallback",
      "description": "Planned-vs-actual mode renders expected-source fallback details when planned rows are partial/missing"
    }
  ],
  "dependencies": [
    {
      "type": "service",
      "name": "open-meteo",
      "notes": "Weather history/forecast context for variance narrative"
    },
    {
      "type": "storage",
      "name": "localStorage",
      "notes": "Context notes persisted via planner saveState payload"
    }
  ],
  "adr_refs": [
    "docs/adr/ADR-0001-ui-governance-baseline.md"
  ],
  "status": "draft",
  "validation": {
    "basis": "approved_product_decision",
    "state": "validated_useful",
    "notes": "Wave 2 review passed. High usefulness for decision loop Learn phase â€” only retrospective analysis surface with day-level granularity and expected-source attribution. Follow-ups: server-side notes, weather confidence scoring, versioned schedule snapshots for planned-vs-actual.",
    "reviewed_on": "2026-02-24",
    "reviewer": "AlexUA"
  }
}
